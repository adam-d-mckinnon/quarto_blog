{
  "hash": "940f6660cb8e23849b3b362f7acee8e4",
  "result": {
    "markdown": "---\ntitle: 'Assessing Bias in ML Models'\ndate: 2023-04-17\ndescription: \"Assessing the presence of bias against minority groups in Machine Learning models to enhance their ethical strength and equality.\"\nauthor: \n    - name: Adam D McKinnon\ncategories: [Bias, Tidymodels, Fairmodels, R]\nimage: \"ai_models_stage.webp\"\ntitle-block-banner: true\ndraft: false\n---\n\n::: {.cell code_folding='false'}\n::: {.cell-output-display}\n![](ai_models_stage.webp){width=100%}\n:::\n:::\n\n\n<br>\n\n# Introduction\n\nModel explainability is a critical component of machine learning (ML) model building. **Ludek Stehlik**, a great contributor in the people analytics community, recently published an excellent [article](https://blog-about-people-analytics.netlify.app/posts/2023-04-13-interpretable-ml/) on the use of the **ModelStudio** package (R ecosystem) for explaining ML models. Inspired by Ludek's blog, I've created the following blog on the use of the **Fairmodels** package in R.\n\n<br>\n\n[![](fairmodels_logo.png){fig-align=\"center\" width=\"200\"}](https://modeloriented.github.io/fairmodels/index.html)\n\n<br>\n\nFairmodels, also built by the developers of ModelStudio, is intended to support assessing, visualising and mitigating the presence of bias in ML models.\n\n<br>\n\n## Setup\n\nWe'll begin by loading the required libraries and loading the dataset. The dataset is the Wage data from the ISLR package, and includes variables such as Age, Marital Status, Education, Region, Job Class, Health Rating, Health Insurance, Race and Wage. To provide context for the article, I've calculated the average Wage by Race (spoiler alert!). It's important to see the potential bias in Wage by Race prior to building the ML model that will predict wages.\n\n<br>\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load required libraries\nlibrary(tidyverse) # data manipulation\nlibrary(tidymodels) # model building\n\nlibrary(DALEX) # model explainer\nlibrary(DALEXtra) # model explainer with tidymodels functionality\nlibrary(fairmodels) # model fairness check\n\n\n# Wage data from the ISLR package\nwage_tbl <- readr::read_csv(file = \"dataset-37830.csv\") |> \n            janitor::clean_names()\n\n\n# get the average wage by race\nwage_tbl |> group_by(race) |> summarise(mean_wage = mean(wage))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 4 × 2\n  race     mean_wage\n  <chr>        <dbl>\n1 1. White     113. \n2 2. Black     102. \n3 3. Asian     120. \n4 4. Other      90.0\n```\n:::\n:::\n\n\n<br><br>\n\n## Model Preparation\n\nThe model preparation involves the following steps:\n\n1.  Convert all character fields to factors and remove redundant fields;\n\n2.  Split the cleaned dataset into Training & Test datasets;\n\n3.  Create a simple recipe for the model building process. More could be done in terms of pre-processing and feature engineering. However, as the focus is on Fairness checks, a simple model will be built to expedite the process.\n\nIt is important to note that the Race variable was left in the dataset, but updated to be an \"id\" field. This ensures that the variable is accessible when needed in our next step, but not utilised in the model building process; and\n\n4.  The values from the \"Protected\" variable (i.e., Race) are pulled out from the processed Training dataset and reserved for later use in the Fairness check. This is a critical component to enable the Fairness check.\n\n<br>\n\n\n::: {.cell}\n\n```{.r .cell-code}\nwage_cleaned_tbl <- wage_tbl %>%\n    mutate_if(is.character, ~as.factor(.)) |> # update character fields to factors for modelling\n    select(-c(logwage, sex)) # Remove unnecessary columns\n\n\n# Split the dataset into training and testing sets\nset.seed(123)\ndata_split <- initial_split(wage_cleaned_tbl, prop = 0.8)\nwage_train_tbl <- training(data_split)\nwage_test_tbl <- testing(data_split)\n\n\n# Create a recipe for preprocessing\nwage_recipe <- recipe(wage ~ ., data = wage_train_tbl) |> \n    recipes::update_role(race, new_role = \"id\")\n\n\n# save out the protected variable (\"Race\") for later reference for Fairness checking\nprotected <- bake(wage_recipe |> prep(), new_data = wage_train_tbl) |> select(race) |> pull()\n```\n:::\n\n\n<br><br>\n\n## Model Specification\n\nA simple Random Forest model is built and then used, in combination with the recipe, in a Tidymodels Workflow, which is subsequently fit to the training dataset. The Workflow is then used to predict unseen values in the Test dataset, which can be compared to the actual values to \"test\" the quality of the model, in this case using the RMSE or Root Mean Square Error.\n\nRMSE helps us measure the performance of a regression-based machine learning model by calculating the average difference between predicted and actual values. A lower RMSE means that the model's predictions are more accurate, just as closer dart throws to the bullseye mean you're a better dart player.\n\n<br>\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Define the model specification\nrf_spec <- rand_forest(trees = 1000) |> \n    set_engine(\"ranger\") |> \n    set_mode(\"regression\") \n    \n\n# Create a workflow\nwage_workflow <- workflow() |> \n    add_recipe(wage_recipe) |> \n    add_model(rf_spec)\n\n\n# Train the model\nwage_fit <- fit(wage_workflow, wage_train_tbl)\n\n\n# Make predictions on the test set\nwage_test_pred <- predict(wage_fit, wage_test_tbl) |> \n    bind_cols(wage_test_tbl)\n\n\n# Evaluate the model performance\nwage_metrics <- metric_set(rmse)\nwage_results <- wage_metrics(wage_test_pred, truth = wage, estimate = .pred)\n\n\nprint(wage_results)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 1 × 3\n  .metric .estimator .estimate\n  <chr>   <chr>          <dbl>\n1 rmse    standard        33.6\n```\n:::\n:::\n\n\n<br><br>\n\n## Model Explainer & Fairness Check\n\nFirst we create the DALEX-based explainer object, which draws upon the fitted Tidymodels Workflow, the training data and our predicted variable, in this instance, Wage. We then use the explainer object to perform a fairness check of the Wage predictions. As the prediction is a value, and not a probability of classification, we use the fairness_check_regression function from Fairmodels.\n\nIt is important to note that the creators of the Fairmodels package consider this funtion to be experimental. The documentation on this function states:\n\n> \"*the metrics in use are independence, separation, and sufficiency. The intuition behind this method is that the closer to 1 the metrics are the better. When all metrics are close to 1 then it means that from the perspective of a predictive model there are no meaningful differences between subgroups*.\"\n\nPrinting the fairness check object provides a summary. Plotting the fairness check object provides a detailed and self-explanatory visualisation of the summary. The visualisation clearly delineates those factor levels that pass the fairness check (i.e., values fall within the green zone), as opposed to those that don't (i.e., values falling within the red zone).\n\n<br>\n\n\n::: {.cell}\n\n```{.r .cell-code}\nwage_explainer <- DALEXtra::explain_tidymodels(\n    wage_fit,\n    data    = wage_train_tbl |> select(-wage),\n    y       = wage_train_tbl$wage,\n    verbose = FALSE\n\n)\n\n\nmodel_performance(wage_explainer)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nMeasures for:  regression\nmse        : 946.0564 \nrmse       : 30.75803 \nr2         : 0.4612749 \nmad        : 14.55176\n\nResiduals:\n          0%          10%          20%          30%          40%          50% \n-102.6445597  -29.0820629  -20.6263656  -13.8813996   -8.8483464   -4.0898662 \n         60%          70%          80%          90%         100% \n   0.9815948    7.1601028   15.4004204   29.9078928  190.8156705 \n```\n:::\n\n```{.r .cell-code}\nfairness_object <- fairness_check_regression(wage_explainer,\n                          protected  = protected,\n                          privileged = \"1. White\",\n                          colorize = TRUE)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nCreating fairness regression object\n-> Privileged subgroup\t\t: character (\u001b[32m Ok \u001b[39m )\n-> Protected variable\t\t: factor (\u001b[32m Ok \u001b[39m ) \n-> Fairness objects\t\t: 0 objects \n-> Checking explainers\t\t: 1 in total ( \u001b[32m compatible \u001b[39m )\n-> Metric calculation\t\t: 3/3 metrics calculated for all models\n\u001b[32m Fairness regression object created succesfully \u001b[39m \n```\n:::\n\n```{.r .cell-code}\nprint(fairness_object)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nFairness check regression for models: workflow \n\n\u001b[31mworkflow passes 1/3 metrics\n\u001b[39mTotal loss:  1.61128 \n```\n:::\n\n```{.r .cell-code}\nplot(fairness_object)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/explainer-1.png){width=672}\n:::\n:::\n\n\n<br>\n\nIndependence, Separation, and Sufficiency are essential metrics when assessing regression-based machine learning models for bias. These metrics help identify potential sources of bias and ensure the reliability and validity of the model's results.\n\n<br>\n\n#### Independence:\n\nIndependence is a metric that measures whether the residuals (the differences between predicted and actual values) are independent of one another. In a well-specified regression model, the residuals should not exhibit any patterns or correlations among themselves.\n\nIn our example the Fairness Check suggests that the residuals from the Wage predictions are correlated with the \"4. Other\" level of the Race variable. This indicates that the model has not adequately accounted for the relationship between the Race predictor and the Wage, which can lead to biased estimates of the effect of Race on Wage. In our example, the \"4. Other\" group appear to consistently receive lower wage predictions.\n\n<br>\n\n#### Separation:\n\nSeparation is a metric that measures whether there is complete separation between predictor variables and the outcome variable. Separation occurs when a certain variable, like the Race of an employee in this example, has an extremely high predictive value for the Wage predicted by the model. While it may be tempting to use this feature to make predictions, doing so could lead to biased outcomes. In our example the \"4. Other\" level in the Race feature nears being outside the bounds of being acceptable.\n\n<br>\n\n#### Sufficiency:\n\nSufficiency is a metric that measures whether the sample size is sufficient to support reliable inferences from the regression model. In general, larger sample sizes provide more reliable estimates and better model performance.\n\nWith small sample sizes, the risk of overfitting increases, and the model may capture noise rather than true relationships between variables, leading to incorrect conclusions about the significance and magnitude of predictor variables' effects. In our example, the sample sizes for each level of the Race variable are considered acceptable by the Fairness Check.\n\n<br>\n\n#### We found bias... now what?\n\nThe current example illustrates that simply omitting a variable, in this case Race, does not eliminate potential bias. The underlying data used for training the model would appear to be biased. Action needs to be taken to mitigate the impact of bias.\n\nWhere bias is found to exist various pre and post processing techniques are available to minimise the influence of potential sources of bias. These methods, while beyond the scope of the current article, are supported by the Fairmodels package and are detailed in the supporting package [documentation](https://modeloriented.github.io/fairmodels/articles/Advanced_tutorial.html#bias-mitigation-strategies-1).\n\n<br>\n\n# Conclusion\n\nAssessing for algorithmic bias is critical prior to applying ML models to support decision making in all spheres of society. Identifying and understanding if algorithms fail certain groups in society ensures that ML models improve decision making to the betterment of all, as opposed to a few.\n\nThe current article illustrates an open-source package, Fairmodels, for assessing, identifying and visualising the presence of bias in ML models. By understanding the metrics for Fairness checks and diagnosing potential violations, researchers can improve the validity and reliability of their models, ultimately leading to more accurate conclusions about the relationships between variables, and thereby mitigating bias toward particular groups. Fair models should lead to the betterment of all!\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}